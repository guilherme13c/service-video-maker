steps:
    - name: gcr.io/cloud-builders/docker
      args:
          [
              "build",
              "-t",
              "$_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME:$COMMIT_SHA",
              "--cache-from",
              "$_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME:latest",
              ".",
          ]
    - name: gcr.io/cloud-builders/docker
      args:
          [
              "push",
              "$_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME:$COMMIT_SHA",
          ]
    - name: gcr.io/google.com/cloudsdktool/cloud-sdk
      entrypoint: gcloud
      args:
          [
              "run",
              "deploy",
              "$REPO_NAME",
              "--image",
              "$_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME:$COMMIT_SHA",
              "--region",
              "$_REGION",
              "--set-env-vars=ENVIRONMENT=PRODUCTION",
              "--timeout=600",
              "--memory=128Mi",
              "--min-instances=0",
              "--cpu=1",
              "--concurrency=120",
              "--allow-unauthenticated",
              "--service-account=$_SERVICE_ACCOUNT",
          ]
images:
    - "$_REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA"

options:
    logging: CLOUD_LOGGING_ONLY

substitutions:
    _REGION: us-central1
    _SERVICE_ACCOUNT: service-video-maker@$PROJECT_ID.iam.gserviceaccount.com
